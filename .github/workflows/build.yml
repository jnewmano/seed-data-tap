name: Image
on:
  push:
    branches: [ main ]
    tags: [ '*' ]

jobs:
  register:
    name: Package, Publish, and Register
    runs-on:
    - ubuntu-latest
    steps:
    - id: checkout
      uses: actions/checkout@v2
    - uses: docker/login-action@v1
      with:
        registry: docker.io
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}
    - id: setup-pack
      uses: buildpacks/github-actions/setup-pack@v4.3.1
    - id: package
      run: |
        #!/usr/bin/env bash
        set -euo pipefail
        
        echo "${GITHUB_REF} ${GITHUB_EVENT_NAME}"

        BP_ID="tap-seed-data"
        VERSION="0.1"
        PACKAGE="${REPO}/tap-seed-data"
        pack build --builder paketobuildpacks/builder:tiny --publish ${PACKAGE}:${VERSION}
        DIGEST="$(crane digest ${PACKAGE}:${VERSION})"
        echo "::set-output name=bp_id::$BP_ID"
        echo "::set-output name=version::$VERSION"
        echo "::set-output name=address::${PACKAGE}@${DIGEST}"
      shell: bash
      env:
        REPO: docker.io/${{ secrets.DOCKER_USERNAME }}
